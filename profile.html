<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim - SkinGenius</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="profile.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <img src="logo.png" alt="SkinGenius Logo" class="site-logo">
            <div class="header-categories">
                <span class="hamburger-menu" id="openSidebar">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </div>
        </header>

        <!-- Sidebar -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-close" id="closeSidebar">&times;</span>
                <span class="sidebar-title">SkinGenius</span>
            </div>

            <!-- Kullanıcı Profil Bölümü -->
            <div id="userProfile" style="display: none;">
                <div class="profile-section">
                    <img src="default-avatar.png" alt="Profil" class="profile-image" id="userProfileImage">
                    <div class="profile-info">
                        <h3 id="userName">Kullanıcı Adı</h3>
                        <p id="userEmail">kullanici@email.com</p>
                    </div>
                </div>
                <div class="profile-actions">
                    <a href="profile.html" class="profile-link active">
                        <span class="material-icons">person</span>
                        Profilim
                    </a>
                    <a href="settings.html" class="profile-link">
                        <span class="material-icons">settings</span>
                        Ayarlar
                    </a>
                    <button onclick="logout()" class="profile-link logout-btn">
                        <span class="material-icons">logout</span>
                        Çıkış Yap
                    </button>
                </div>
            </div>

            <!-- Giriş Yapmamış Kullanıcılar İçin -->
            <div id="guestProfile">
                <div class="profile-section">
                    <img src="default-avatar.png" alt="Misafir" class="profile-image">
                    <div class="profile-info">
                        <h3>Misafir Kullanıcı</h3>
                        <p>Giriş yaparak tüm özelliklere erişin</p>
                    </div>
                </div>
                <div class="profile-actions">
                    <a href="login.html" class="profile-link">
                        <span class="material-icons">login</span>
                        Giriş Yap
                    </a>
                    <a href="login.html?tab=register" class="profile-link">
                        <span class="material-icons">person_add</span>
                        Kayıt Ol
                    </a>
                </div>
            </div>

            <!-- Ana Menü -->
            <div class="menu-section">
                <h3>Ana Menü</h3>
                <a href="index.html" class="menu-link">
                    <span class="material-icons">home</span>
                    Ana Sayfa
                </a>
                <a href="analysis.html" class="menu-link">
                    <span class="material-icons">face</span>
                    Cilt Analizi
                </a>
                <a href="products.html" class="menu-link">
                    <span class="material-icons">spa</span>
                    Ürünler
                </a>
                <a href="settings.html" class="menu-link">
                    <span class="material-icons">settings</span>
                    Ayarlar
                </a>
            </div>

            <!-- Destek -->
            <div class="menu-section">
                <h3>Destek</h3>
                <a href="faq.html" class="menu-link">
                    <span class="material-icons">help</span>
                    Sık Sorulan Sorular
                </a>
                <a href="contact.html" class="menu-link">
                    <span class="material-icons">contact_support</span>
                    İletişim
                </a>
            </div>
        </nav>

        <!-- Ana İçerik -->
        <main class="profile-page">
            <div class="profile-section">
                <div class="profile-header">
                    <div class="profile-image-container">
                        <img src="default-avatar.png" alt="Profil" class="profile-image" id="profileImage">
                        <button class="change-photo-btn" onclick="document.getElementById('photoInput').click()">
                            <span class="material-icons">photo_camera</span>
                        </button>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="profile-info">
                        <h2 id="profileName"></h2>
                    </div>
                </div>

                <form id="profileForm" class="edit-form" onsubmit="return false;">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="editName" name="displayName" placeholder="Adınız ve soyadınız" required>
                        </div>
                        <div class="form-group">
                            <input type="email" id="editEmail" name="email" placeholder="E-posta adresiniz">
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button type="submit" class="save-btn">
                            <span class="material-icons">save</span>
                            Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <!-- Analiz Geçmişi -->
            <div class="profile-section">
                <h3>Analiz Geçmişim</h3>
                <div class="analysis-timeline" id="analysisHistory">
                    <!-- Analiz geçmişi JavaScript ile doldurulacak -->
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // Firebase yapılandırması
        const firebaseConfig = {
            // Firebase yapılandırma bilgileriniz buraya gelecek
        };

        // Firebase'i başlat
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Kullanıcı bilgilerini yükleme ve gösterme fonksiyonu
        async function loadUserData(user) {
            try {
                // Firestore'dan kullanıcı bilgilerini al
                const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                const userData = userDoc.data();

                // Profil bilgilerini güncelle
                updateProfileDisplay(user, userData);
            } catch (error) {
                console.error('Kullanıcı bilgileri yüklenirken hata:', error);
                showNotification('Kullanıcı bilgileri yüklenirken bir hata oluştu', 'error');
            }
        }

        function updateProfileDisplay(user, userData) {
            // Form alanlarını doldur
            const nameInput = document.getElementById('editName');
            const emailInput = document.getElementById('editEmail');

            // Kullanıcı adı için öncelik sırası:
            nameInput.value = userData?.displayName || user.displayName || '';
            nameInput.placeholder = 'Adınız ve soyadınız';

            // E-posta için öncelik sırası:
            emailInput.value = userData?.email || user.email || '';
            emailInput.placeholder = 'E-posta adresiniz';

            // Profil fotoğrafı
            const profileImage = document.getElementById('profileImage');
            if (user.photoURL) {
                profileImage.src = user.photoURL;
            } else if (userData?.photoURL) {
                profileImage.src = userData.photoURL;
            } else {
                profileImage.src = 'default-avatar.png';
            }

            // Sidebar profil bilgileri
            document.getElementById('userName').textContent = userData?.displayName || user.displayName || 'Kullanıcı';
            document.getElementById('userEmail').textContent = userData?.email || user.email || '';
            const sidebarProfileImage = document.getElementById('userProfileImage');
            if (sidebarProfileImage) {
                sidebarProfileImage.src = userData?.photoURL || user.photoURL || 'default-avatar.png';
            }
        }

        // Sayfa yüklendiğinde kullanıcı bilgilerini yükle
        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Kullanıcı oturum açmışsa bilgileri yükle
                    await loadUserData(user);
                } else {
                    // Kullanıcı oturum açmamışsa login sayfasına yönlendir
                    window.location.href = 'login.html';
                }
            });
        });

        // Profil formu gönderimi
        document.addEventListener('DOMContentLoaded', function() {
            const profileForm = document.getElementById('profileForm');
            profileForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveProfile(e);
            });

            // Profil fotoğrafı değiştirme
            const photoInput = document.getElementById('photoInput');
            photoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Dosya boyutu 5MB\'dan küçük olmalıdır', 'error');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    showNotification('Lütfen geçerli bir resim dosyası seçin', 'error');
                    return;
                }

                try {
                    await changeProfilePhoto(file);
                } catch (error) {
                    console.error("Fotoğraf yüklenirken hata:", error);
                    showNotification('Fotoğraf yüklenirken bir hata oluştu', 'error');
                }
            });
        });

        // Profil bilgilerini kaydet
        async function saveProfile(event) {
            event.preventDefault();
            
            const user = firebase.auth().currentUser;
            if (!user) {
                showNotification('Oturum açmanız gerekiyor', 'error');
                return;
            }

            const newName = document.getElementById('editName').value.trim();
            const newEmail = document.getElementById('editEmail').value.trim();

            // E-posta değişikliği kontrolü
            if (newEmail !== user.email) {
                try {
                    await user.updateEmail(newEmail);
                    await user.sendEmailVerification();
                    showNotification('E-posta adresiniz güncellendi. Lütfen yeni e-posta adresinizi doğrulayın.', 'success');
                } catch (error) {
                    console.error('E-posta güncelleme hatası:', error);
                    showNotification('E-posta güncellenirken bir hata oluştu: ' + error.message, 'error');
                    return;
                }
            }

            try {
                // Profil bilgilerini güncelle
                const updates = {
                    displayName: newName
                };

                // Firebase Auth'da profil güncelleme
                await user.updateProfile(updates);

                // Firestore'da kullanıcı bilgilerini güncelle
                await firebase.firestore().collection('users').doc(user.uid).set({
                    displayName: newName,
                    email: newEmail,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Profil bilgilerini güncelle
                updateProfileDisplay(user, {
                    displayName: newName,
                    email: newEmail
                });

                showNotification('Profil bilgileriniz başarıyla güncellendi', 'success');
            } catch (error) {
                console.error('Profil güncelleme hatası:', error);
                showNotification('Profil güncellenirken bir hata oluştu: ' + error.message, 'error');
            }
        }

        // Profil fotoğrafını değiştir
        async function changeProfilePhoto(file) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const storage = firebase.storage();
                const storageRef = storage.ref();
                const photoRef = storageRef.child(`profile_photos/${user.uid}`);

                // Fotoğrafı yükle
                const snapshot = await photoRef.put(file);
                const photoURL = await snapshot.ref.getDownloadURL();

                // Kullanıcı profilini güncelle
                await user.updateProfile({
                    photoURL: photoURL
                });

                // Firestore'da da güncelle
                const db = firebase.firestore();
                await db.collection('users').doc(user.uid).update({
                    photoURL: photoURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Profil fotoğrafını güncelle
                document.getElementById('profileImage').src = photoURL;
                showNotification('Profil fotoğrafı başarıyla güncellendi!', 'success');
            } catch (error) {
                console.error("Fotoğraf yüklenirken hata:", error);
                throw error;
            }
        }

        // Bildirim göster
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="material-icons">${type === 'success' ? 'check_circle' : 'info'}</span>
                ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Sidebar işlemleri
        function initializeSidebar() {
            const openSidebar = document.getElementById('openSidebar');
            const closeSidebar = document.getElementById('closeSidebar');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (openSidebar && closeSidebar && sidebar && overlay) {
                openSidebar.addEventListener('click', () => {
                    sidebar.classList.add('open');
                    overlay.style.display = 'block';
                });

                closeSidebar.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    overlay.style.display = 'none';
                });

                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    overlay.style.display = 'none';
                });
            }
        }

        // Sayfa yüklendiğinde sidebar'ı başlat
        document.addEventListener('DOMContentLoaded', initializeSidebar);
    </script>
</body>
</html> 